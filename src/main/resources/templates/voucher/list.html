<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{view/layout}">

<head>
  <meta charset="UTF-8">
  <title>Quáº£n lÃ½ Voucher</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    body {
      background-color: #f8f9fa;
    }

    h3, h4 {
      color: #2c3e50;
    }

    .card {
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .btn {
      min-width: 100px;
    }

    .table {
      background-color: white;
      border-radius: 8px;
      overflow: hidden;
    }

    .table-hover tbody tr:hover {
      background-color: #e3f2fd;
      cursor: pointer;
    }

    tr.table-warning {
      background-color: #fff3cd !important;
    }

    .form-label {
      font-weight: 500;
    }

    .form-control:focus, .form-select:focus {
      box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
    }

    #form-title {
      font-weight: bold;
      color: #0d6efd;
    }
  </style>
</head>

<body>
<div layout:fragment="content">
  <div class="container mt-5">

    <!-- FORM VOUCHER -->
    <div class="row justify-content-center">
      <div class="col-lg-6">
        <div class="card p-4 mb-4">
          <h4 id="form-title" class="text-center mb-3">ThÃªm má»›i voucher</h4>
          <form id="voucherForm">
            <input type="hidden" id="id">
            <div class="mb-3">
              <label class="form-label">MÃ£</label>
              <input type="text" id="ma" class="form-control" required>
            </div>
            <div class="mb-3">
              <label class="form-label">NgÃ y báº¯t Ä‘áº§u</label>
              <input type="date" id="ngayBatDau" class="form-control" required>
            </div>
            <div class="mb-3">
              <label class="form-label">NgÃ y káº¿t thÃºc</label>
              <input type="date" id="ngayKetThuc" class="form-control" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Pháº§n trÄƒm giáº£m</label>
              <input type="number" id="phanTramGiam" class="form-control" min="1" max="100" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Tráº¡ng thÃ¡i</label>
              <select id="trangThai" class="form-select">
                <option value="true">Hoáº¡t Ä‘á»™ng</option>
                <option value="false">KhÃ´ng hoáº¡t Ä‘á»™ng</option>
              </select>
            </div>
            <div class="d-flex justify-content-center gap-2">
              <button type="submit" class="btn btn-success" id="btnLuu">ThÃªm</button>
              <button type="button" class="btn btn-secondary" id="btnReset">Reset</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- DANH SÃCH -->
    <div class="row">
      <div class="col-lg-12">
        <h3 class="text-center mb-3">Danh sÃ¡ch Voucher</h3>
        <div class="table-responsive">
          <table class="table table-bordered table-hover shadow-sm">
            <thead class="table-dark text-center">
              <tr>
                <th>ID</th>
                <th>MÃ£</th>
                <th>Báº¯t Ä‘áº§u</th>
                <th>Káº¿t thÃºc</th>
                <th>Giáº£m (%)</th>
                <th>Tráº¡ng thÃ¡i</th>
                <th>HÃ nh Ä‘á»™ng</th>
              </tr>
            </thead>
            <tbody>
              <tr th:each="v : ${listVoucher}" th:data-id="${v.id}" class="voucher-row text-center align-middle">
                <td th:text="${v.id}"></td>
                <td th:text="${v.ma}"></td>
                <td th:text="${#dates.format(v.ngayBatDau, 'yyyy-MM-dd')}"></td>
                <td th:text="${#dates.format(v.ngayKetThuc, 'yyyy-MM-dd')}"></td>
                <td th:text="${v.phanTramGiam} + '%'"></td>
                <td>
                  <span th:text="${v.trangThai ? 'Hoáº¡t Ä‘á»™ng' : 'KhÃ´ng hoáº¡t Ä‘á»™ng'}"
                        th:classappend="${v.trangThai ? 'text-success' : 'text-danger'}"></span>
                </td>
                <td>
                  <a th:href="@{'/voucher/view/toggle-status/' + ${v.id}}"
                     class="btn btn-sm"
                     th:classappend="${v.trangThai ? 'btn-danger' : 'btn-success'}"
                     th:text="${v.trangThai ? 'ðŸ›‘ Dá»«ng' : 'âœ… KÃ­ch hoáº¡t'}">
                  </a>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

  </div>
</div>

<!-- SCRIPT -->
<div layout:fragment="scripts">
  <script>
    document.addEventListener("DOMContentLoaded", function () {
      const form = document.getElementById("voucherForm");
      const btnLuu = document.getElementById("btnLuu");
      const btnReset = document.getElementById("btnReset");
      const tbody = document.querySelector("tbody");

      tbody.addEventListener("click", function (e) {
        const row = e.target.closest(".voucher-row");
        if (!row || e.target.tagName === "A") return; // KhÃ´ng kÃ­ch hoáº¡t khi click vÃ o nÃºt dá»«ng/kÃ­ch hoáº¡t

        document.querySelectorAll(".voucher-row").forEach(r => r.classList.remove("table-warning"));
        row.classList.add("table-warning");

        const id = row.dataset.id;
        fetch(`/voucher/view/edit/${id}`)
          .then(res => res.json())
          .then(data => {
            document.getElementById("id").value = data.id;
            document.getElementById("ma").value = data.ma;
            document.getElementById("ngayBatDau").value = data.ngayBatDau.substring(0, 10);
            document.getElementById("ngayKetThuc").value = data.ngayKetThuc.substring(0, 10);
            document.getElementById("phanTramGiam").value = data.phanTramGiam;
            document.getElementById("trangThai").value = data.trangThai.toString();
            document.getElementById("form-title").innerText = "Cáº­p nháº­t voucher";
            btnLuu.innerText = "Cáº­p nháº­t";
            form.scrollIntoView({ behavior: "smooth" });
          })
          .catch(err => alert("Lá»—i: " + err.message));
      });

      btnReset.addEventListener("click", function () {
        form.reset();
        document.getElementById("id").value = "";
        document.getElementById("form-title").innerText = "ThÃªm má»›i voucher";
        btnLuu.innerText = "ThÃªm";
        document.querySelectorAll(".voucher-row").forEach(r => r.classList.remove("table-warning"));
      });

      form.addEventListener("submit", function (e) {
        e.preventDefault();

        const payload = {
          id: document.getElementById("id").value || null,
          ma: document.getElementById("ma").value,
          ngayBatDau: document.getElementById("ngayBatDau").value,
          ngayKetThuc: document.getElementById("ngayKetThuc").value,
          phanTramGiam: document.getElementById("phanTramGiam").value,
          trangThai: document.getElementById("trangThai").value === "true"
        };

        fetch("/voucher/view/save", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        })
          .then(res => {
            if (!res.ok) return res.text().then(text => { throw new Error(text) });
            return res.text();
          })
          .then(msg => {
            alert(msg);
            location.reload();
          })
          .catch(err => alert("Lá»—i: " + err.message));
      });
    });
  </script>
</div>

</body>
</html>
