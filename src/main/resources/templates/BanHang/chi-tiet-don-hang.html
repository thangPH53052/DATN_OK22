<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{view/layout}">
<head>
    <title>Chi Ti·∫øt ƒê∆°n H√†ng</title>
    <link rel="stylesheet"
          href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
          crossorigin="anonymous"/>
    <link rel="stylesheet" 
          href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" 
          crossorigin="anonymous"/>
</head>
<body>
<div layout:fragment="content">
    <div class="container mt-4">
        <h2 class="mb-4 text-success">Chi Ti·∫øt ƒê∆°n H√†ng</h2>

        <!-- N√∫t quay l·∫°i -->
        <div class="mb-3">
            <a th:href="@{/ban-hang/view}" class="btn btn-secondary">
                ‚¨Ö Quay l·∫°i trang qu·∫£n l√Ω b√°n h√†ng
            </a>
        </div>

        <!-- Th√¥ng tin h√≥a ƒë∆°n -->
        <div class="mb-4 p-3 bg-light border rounded">
            <p><strong>Kh√°ch H√†ng:</strong> <span th:text="${hoaDon.khachHang?.ten ?: 'Kh√°ch l·∫ª'}"></span></p>
            <p><strong>Tr·∫°ng Th√°i:</strong>
                <span th:text="${hoaDon.trangThai == 1 ? 'Ho√†n t·∫•t' : 'Ch·ªù thanh to√°n'}"></span></p>
            <p><strong>Ng√†y T·∫°o:</strong>
                <span th:text="${#dates.format(hoaDon.ngayTao, 'dd-MM-yyyy HH:mm')}"></span></p>
        </div>

        <!-- Danh s√°ch s·∫£n ph·∫©m -->
<table class="table table-bordered">
    <thead class="table-secondary">
        <tr>
            <th>T√™n S·∫£n Ph·∫©m</th>
            <th>K√≠ch C·ª°</th>
            <th>M√†u S·∫Øc</th>
            <th>C·∫≠p Nh·∫≠t SL</th>
            <th>ƒê∆°n Gi√°</th>
            <th>Th√†nh Ti·ªÅn</th>
            <th>X√≥a</th>
        </tr>
    </thead>
    <tbody>
        <tr th:each="ct : ${hoaDon.chiTietList}">
            <td th:text="${ct.sanPhamChiTiet.sanPham.ten}">SP</td>
            <td th:text="${ct.sanPhamChiTiet.kichThuoc.ten}">Size</td>
            <td th:text="${ct.sanPhamChiTiet.mauSac.ten}">M√†u</td>
            <td>
                <form th:action="@{/ban-hang/cap-nhat-so-luong}" method="post" class="d-flex">
                    <input type="hidden" name="chiTietId" th:value="${ct.id}" />
                    <input type="number" name="soLuongMoi"
                           th:value="${ct.soLuong}" min="1"
                           th:attr="max=${ct.sanPhamChiTiet.soLuong + ct.soLuong}"
                           class="form-control form-control-sm me-2"
                           style="width: 70px;" required />
                    <button type="submit" class="btn btn-sm btn-outline-primary">C·∫≠p nh·∫≠t</button>
                </form>
            </td>
            <td th:text="${#numbers.formatDecimal(ct.donGia, 0, 'COMMA', 0, 'POINT')} + ' VNƒê'">Gi√°</td>
            <td th:text="${#numbers.formatDecimal(ct.soLuong * ct.donGia, 0, 'COMMA', 0, 'POINT')} + ' VNƒê'">TT</td>
            <td>
                <form th:action="@{/ban-hang/xoa-chi-tiet}" method="post">
                    <input type="hidden" name="chiTietId" th:value="${ct.id}" />
                    <button class="btn btn-sm btn-danger">X√≥a</button>
                </form>
            </td>
        </tr>
    </tbody>
</table>


        <!-- T·ªïng ti·ªÅn + voucher + thanh to√°n -->
        <div class="d-flex justify-content-between align-items-start mt-3 gap-4 flex-wrap">

            <!-- T·ªïng ti·ªÅn -->
            <div>
                <p class="fw-bold mb-2">
                    T·∫°m t√≠nh:
                    <span th:text="${#numbers.formatDecimal(hoaDon.tongTien, 0, 'COMMA', 0, 'POINT')} + ' VNƒê'"></span>
                    | Gi·∫£m gi√°:
                    <span th:text="${hoaDon.voucher?.phanTramGiam + '%'} ?: '0%'"></span>
                    | T·ªïng ti·ªÅn:
                    <span th:text="${#numbers.formatDecimal(
                        hoaDon.voucher != null ? hoaDon.tongTien * (1 - hoaDon.voucher.phanTramGiam / 100.0) : hoaDon.tongTien,
                        0, 'COMMA', 0, 'POINT')} + ' VNƒê'"></span>
                </p>

                <!-- Form ch·ªçn voucher -->
                <form th:action="@{/ban-hang/chon-voucher}" method="post" class="d-flex align-items-center mt-2">
                    <input type="hidden" name="hoaDonId" th:value="${hoaDon.id}"/>
                    <select name="voucherId" class="form-select form-select-sm me-2" style="width: 200px">
                        <option value="">-- Kh√¥ng √°p d·ª•ng --</option>
                        <option th:each="v : ${voucherList}"
                                th:value="${v.id}"
                                th:text="${v.ma + ' - Gi·∫£m ' + v.phanTramGiam + '%'}"
                                th:selected="${hoaDon.voucher?.id == v.id}"></option>
                    </select>
                    <button type="submit" class="btn btn-sm btn-primary">√Åp d·ª•ng</button>
                </form>
            </div>

            <!-- Thanh to√°n -->
            <!-- Thanh to√°n -->
<div class="p-3 bg-light border rounded" style="min-width: 300px;">
  <h5 class="mb-3">Thanh To√°n</h5>
  <form th:action="@{/ban-hang/thanh-toan}" method="post" class="row g-2" id="formThanhToan">
    <input type="hidden" name="hoaDonId" th:value="${hoaDon.id}"/>

    <div class="col-12">
      <label class="form-label">Ph∆∞∆°ng th·ª©c thanh to√°n:</label>
      <select class="form-select" name="phuongThuc" id="phuongThucSelect" required>
        <option value="TIEN_MAT">Ti·ªÅn m·∫∑t</option>
        <option value="CHUYEN_KHOAN">Chuy·ªÉn kho·∫£n</option>
      </select>
    </div>

    <div class="col-12" id="tienMatGroup">
      <label class="form-label">Ti·ªÅn kh√°ch ƒë∆∞a:</label>
      <input type="number" name="tienKhachDua" id="tienKhachDuaInput" class="form-control" min="0"/>
    </div>

    <div class="col-12 d-grid mt-2">
      <button type="submit" class="btn btn-success">üí∞ Thanh To√°n</button>
    </div>
  </form>

  <div th:if="${loiThanhToan}" class="alert alert-danger mt-3" th:text="${loiThanhToan}"></div>
  <div th:if="${tienThua != null}" class="alert alert-success mt-3"
       th:text="'Thanh to√°n th√†nh c√¥ng! Ti·ªÅn th·ª´a: ' + ${#numbers.formatDecimal(tienThua, 0, 'COMMA', 0, 'POINT')} + ' VNƒê'">
  </div>
</div>


        <!-- N√∫t m·ªü modal -->
        <div class="text-end mt-4">
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalSanPham">
                ‚ûï Th√™m S·∫£n Ph·∫©m
            </button>
        </div>

        <!-- Modal ch·ªçn s·∫£n ph·∫©m -->
<div class="modal fade" id="modalSanPham" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Ch·ªçn S·∫£n Ph·∫©m</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div th:if="${themSanPhamLoi}" class="alert alert-danger" th:text="${themSanPhamLoi}"></div>
                
                <!-- B·ªô l·ªçc s·∫£n ph·∫©m -->
                <div class="card mb-4">
                    <div class="card-header bg-light">
                        <h6 class="mb-0">
                            <a class="text-dark text-decoration-none" data-bs-toggle="collapse" href="#collapseFilter" role="button">
                                <i class="fas fa-filter"></i> B·ªô l·ªçc s·∫£n ph·∫©m
                            </a>
                        </h6>
                    </div>
                    <div class="collapse show" id="collapseFilter">
                        <div class="card-body">
                            <form th:action="@{/ban-hang/chon-hoa-don/{id}(id=${hoaDon.id})}" method="get" id="filterForm">
                                <div class="row">
                                    <!-- T√¨m ki·∫øm theo t√™n -->
                                    <div class="col-md-4 mb-3">
                                        <label class="form-label">T√™n s·∫£n ph·∫©m</label>
                                        <input type="text" class="form-control filter-input" name="tenSanPham" th:value="${tenSanPhamFilter}">
                                    </div>
                                    
                                    <!-- Danh m·ª•c -->
                                    <div class="col-md-4 mb-3">
                                        <label class="form-label">Danh m·ª•c</label>
                                        <select class="form-select filter-select" name="danhMucId">
                                            <option value="">-- T·∫•t c·∫£ --</option>
                                            <option th:each="dm : ${danhMucList}" 
                                                    th:value="${dm.id}" 
                                                    th:text="${dm.ten}"
                                                    th:selected="${dm.id == danhMucIdFilter}"></option>
                                        </select>
                                    </div>
                                    
                                    <!-- Th∆∞∆°ng hi·ªáu -->
                                    <div class="col-md-4 mb-3">
                                        <label class="form-label">Th∆∞∆°ng hi·ªáu</label>
                                        <select class="form-select filter-select" name="thuongHieuId">
                                            <option value="">-- T·∫•t c·∫£ --</option>
                                            <option th:each="th : ${thuongHieuList}" 
                                                    th:value="${th.id}" 
                                                    th:text="${th.ten}"
                                                    th:selected="${th.id == thuongHieuIdFilter}"></option>
                                        </select>
                                    </div>
                                    
                                    <!-- M√†u s·∫Øc -->
                                    <div class="col-md-4 mb-3">
                                        <label class="form-label">M√†u s·∫Øc</label>
                                        <select class="form-select filter-select" name="mauSac">
                                            <option value="">-- T·∫•t c·∫£ --</option>
                                            <option th:each="ms : ${mauSacList}" 
                                                    th:value="${ms.ten}" 
                                                    th:text="${ms.ten}"
                                                    th:selected="${ms.ten == mauSacFilter}"></option>
                                        </select>
                                    </div>
                                    
                                    <!-- K√≠ch th∆∞·ªõc -->
                                    <div class="col-md-4 mb-3">
                                        <label class="form-label">K√≠ch th∆∞·ªõc</label>
                                        <select class="form-select filter-select" name="kichThuoc">
                                            <option value="">-- T·∫•t c·∫£ --</option>
                                            <option th:each="kt : ${kichThuocList}" 
                                                    th:value="${kt.ten}" 
                                                    th:text="${kt.ten}"
                                                    th:selected="${kt.ten == kichThuocFilter}"></option>
                                        </select>
                                    </div>
                                    
                                    <!-- Ch·∫•t li·ªáu -->
                                    <div class="col-md-4 mb-3">
                                        <label class="form-label">Ch·∫•t li·ªáu</label>
                                        <select class="form-select filter-select" name="chatLieuId">
                                            <option value="">-- T·∫•t c·∫£ --</option>
                                            <option th:each="cl : ${chatLieuList}" 
                                                    th:value="${cl.id}" 
                                                    th:text="${cl.ten}"
                                                    th:selected="${cl.id == chatLieuIdFilter}"></option>
                                        </select>
                                    </div>
                                    
                                    <!-- Ki·ªÉu d√¢y -->
                                    <div class="col-md-4 mb-3">
                                        <label class="form-label">Ki·ªÉu d√¢y</label>
                                        <select class="form-select filter-select" name="kieuDayId">
                                            <option value="">-- T·∫•t c·∫£ --</option>
                                            <option th:each="kd : ${kieuDayList}" 
                                                    th:value="${kd.id}" 
                                                    th:text="${kd.ten}"
                                                    th:selected="${kd.id == kieuDayIdFilter}"></option>
                                        </select>
                                    </div>
                                    
                                    <!-- Lo·∫°i kh√≥a -->
                                    <div class="col-md-4 mb-3">
                                        <label class="form-label">Lo·∫°i kh√≥a</label>
                                        <select class="form-select filter-select" name="loaiKhoaId">
                                            <option value="">-- T·∫•t c·∫£ --</option>
                                            <option th:each="lk : ${loaiKhoaList}" 
                                                    th:value="${lk.id}" 
                                                    th:text="${lk.ten}"
                                                    th:selected="${lk.id == loaiKhoaIdFilter}"></option>
                                        </select>
                                    </div>
                                    
                                    <!-- Gi√° t·ª´ -->
                                    <div class="col-md-2 mb-3">
                                        <label class="form-label">Gi√° t·ª´</label>
                                        <input type="number" class="form-control filter-price" name="giaMin" th:value="${giaMinFilter}" min="0">
                                    </div>
                                    
                                    <!-- Gi√° ƒë·∫øn -->
                                    <div class="col-md-2 mb-3">
                                        <label class="form-label">Gi√° ƒë·∫øn</label>
                                        <input type="number" class="form-control filter-price" name="giaMax" th:value="${giaMaxFilter}" min="0">
                                    </div>
                                </div>
                                
                                <div class="d-flex justify-content-between mt-2">
                                    <button type="submit" id="applyFilters" class="btn btn-primary">
                                        <i class="fas fa-filter"></i> 
                                    </button>
                                    <a href="#" id="resetFilters" class="btn btn-outline-secondary">
                                        <i class="fas fa-redo"></i> ƒê·∫∑t l·∫°i
                                    </a>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Danh s√°ch s·∫£n ph·∫©m -->
                <div class="row" th:if="${!#lists.isEmpty(sanPhamList)}">
                    <div class="col-md-4 mb-3" th:each="sp : ${sanPhamList}">
                        <form th:action="@{/ban-hang/them-san-pham}" method="post">
                            <div class="card h-100 border"
                                 th:classappend="${!sp.trangThai} ? 'border-danger'">
                                <div class="card-body">
                                    <input type="hidden" name="hoaDonId" th:value="${hoaDon.id}"/>
                                    <input type="hidden" name="sanPhamChiTietId" th:value="${sp.id}"/>

                                    <!-- H√¨nh ·∫£nh -->
                                    <div class="text-center mb-2">
                                        <img th:if="${not #lists.isEmpty(sp.sanPham.hinhAnhUrls)}"
                                             th:src="@{'/images/' + ${sp.sanPham.hinhAnhUrls[0]}}"
                                             class="img-thumbnail" style="max-height: 130px"
                                             alt="·∫¢nh s·∫£n ph·∫©m"/>
                                    </div>

                                    <h5 th:text="${sp.sanPham.ten}">T√™n SP</h5>
                                    <p>
                                        <strong>M√†u:</strong> <span th:text="${sp.mauSac.ten}"></span><br/>
                                        <strong>Size:</strong> <span th:text="${sp.kichThuoc.ten}"></span><br/>
                                        <strong>C√≤n:</strong> <span th:text="${sp.soLuong} + ' s·∫£n ph·∫©m'"></span><br/>
                                        <strong>Gi√°:</strong>
                                        <span th:if="${sp.khuyenMai != null && sp.khuyenMai.trangThai}">
                                            <s th:text="${#numbers.formatDecimal(sp.giaBan, 0, 'COMMA', 0, 'POINT')} + 'ƒë'"></s><br/>
                                            <b th:text="${#numbers.formatDecimal(sp.giaSauKhuyenMai, 0, 'COMMA', 0, 'POINT')} + 'ƒë'"></b>
                                        </span>
                                        <span th:if="${sp.khuyenMai == null || !sp.khuyenMai.trangThai}"
                                              th:text="${#numbers.formatDecimal(sp.giaBan, 0, 'COMMA', 0, 'POINT')} + 'ƒë'"></span>
                                    </p>

                                    <!-- Ch·ªâ hi·ªÉn th·ªã input n·∫øu c√≤n h√†ng v√† ƒëang b√°n -->
                                    <div th:if="${sp.soLuong > 0 and sp.trangThai}" class="d-flex gap-2 align-items-center">
                                        <input type="number" name="soLuong"
                                               min="1"
                                               th:attr="max=${sp.soLuong}"
                                               value="1"
                                               class="form-control form-control-sm"
                                               style="width: 80px" required/>
                                        <button class="btn btn-sm btn-success">‚úî Ch·ªçn</button>
                                    </div>

                                    <!-- C·∫£nh b√°o n·∫øu h·∫øt h√†ng ho·∫∑c ng·ª´ng b√°n -->
                                    <div th:if="${sp.soLuong == 0 or !sp.trangThai}"
                                         class="text-danger fw-bold mt-2 text-center">
                                        <span th:if="${sp.soLuong == 0}">H·∫øt h√†ng</span>
                                        <span th:if="${!sp.trangThai}">Ng·ª´ng b√°n</span>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>

                <div th:if="${#lists.isEmpty(sanPhamList)}"
                     class="alert alert-warning text-center mt-3">
                    Kh√¥ng c√≥ s·∫£n ph·∫©m n√†o ph√π h·ª£p v·ªõi b·ªô l·ªçc!
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
            </div>
        </div>
    </div>
</div>


        <!-- M·ªü l·∫°i modal n·∫øu c√≥ l·ªói -->
        <script th:if="${moModal}">
            const modalSanPham = new bootstrap.Modal(document.getElementById("modalSanPham"));
            modalSanPham.show();
        </script>

        <!-- JavaScript ki·ªÉm tra s·ªë l∆∞·ª£ng v∆∞·ª£t kho -->
       <script>
  document.addEventListener("DOMContentLoaded", function () {
    const phuongThucSelect = document.getElementById("phuongThucSelect");
    const tienMatGroup = document.getElementById("tienMatGroup");
    const tienKhachInput = document.getElementById("tienKhachDuaInput");

    function toggleTienMat() {
      if (phuongThucSelect.value === "TIEN_MAT") {
        tienMatGroup.style.display = "block";
        tienKhachInput.required = true;
      } else {
        tienMatGroup.style.display = "none";
        tienKhachInput.required = false;
        tienKhachInput.value = "";
      }
    }

    phuongThucSelect.addEventListener("change", toggleTienMat);
    toggleTienMat(); // init on load
  });
</script>


        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
                crossorigin="anonymous"></script>
                
        <!-- Script cho b·ªô l·ªçc t·ª± ƒë·ªông -->
        <script>
            document.addEventListener('DOMContentLoaded', function() {
                // L·∫•y c√°c ph·∫ßn t·ª≠ DOM
                const filterForm = document.getElementById('filterForm');
                const filterSelects = document.querySelectorAll('.filter-select');
                const filterInputs = document.querySelectorAll('.filter-input');
                const filterPrices = document.querySelectorAll('.filter-price');
                const resetFilters = document.getElementById('resetFilters');
                const applyFilters = document.getElementById('applyFilters');
                
                // L∆∞u tr·∫°ng th√°i modal
                const modalSanPham = document.getElementById('modalSanPham');
                const bsModal = new bootstrap.Modal(modalSanPham);
                
                // ƒê·∫£m b·∫£o modal lu√¥n m·ªü sau khi trang t·∫£i l·∫°i
                if (window.location.href.includes('?')) {
                    setTimeout(() => {
                        bsModal.show();
                    }, 500);
                }
                
                // H√†m x·ª≠ l√Ω khi √°p d·ª•ng b·ªô l·ªçc
                function submitForm() {
                    filterForm.submit();
                }
                
                // S·ª± ki·ªán cho n√∫t √°p d·ª•ng b·ªô l·ªçc
                applyFilters.addEventListener('click', submitForm);
                
                // S·ª± ki·ªán cho n√∫t ƒë·∫∑t l·∫°i
                resetFilters.addEventListener('click', function() {
                    // Reset t·∫•t c·∫£ c√°c tr∆∞·ªùng
                    filterSelects.forEach(select => select.selectedIndex = 0);
                    filterInputs.forEach(input => input.value = '');
                    filterPrices.forEach(price => price.value = '');
                    
                    // G·ª≠i form
                    submitForm();
                });
                
                // S·ª± ki·ªán cho c√°c select
                filterSelects.forEach(select => {
                    select.addEventListener('change', function() {
                        // Th√™m timeout nh·ªè ƒë·ªÉ tr√°nh qu√° nhi·ªÅu request khi ng∆∞·ªùi d√πng ƒëang ch·ªçn
                        setTimeout(submitForm, 300);
                    });
                });
                
                // S·ª± ki·ªán cho c√°c input text (t√¨m ki·∫øm theo t√™n)
                filterInputs.forEach(input => {
                    // S·ª≠ d·ª•ng s·ª± ki·ªán input v·ªõi debounce ƒë·ªÉ tr√°nh g·ª≠i qu√° nhi·ªÅu request
                    let debounceTimer;
                    input.addEventListener('input', function() {
                        clearTimeout(debounceTimer);
                        debounceTimer = setTimeout(submitForm, 500);
                    });
                });
                
                // S·ª± ki·ªán cho c√°c input gi√°
                filterPrices.forEach(price => {
                    // S·ª≠ d·ª•ng s·ª± ki·ªán change ƒë·ªÉ ch·ªâ g·ª≠i khi ng∆∞·ªùi d√πng ƒë√£ xong vi·ªác nh·∫≠p
                    price.addEventListener('change', submitForm);
                });
            });
        </script>
    </div>
</div>
</body>
</html>
